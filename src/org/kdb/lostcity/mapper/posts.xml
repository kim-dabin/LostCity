<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="posts">

<select id="selectOne" resultType="Post" parameterType="int">
SELECT p.no no, p.explorer_no explorerNo, p.title title, p.content content, p.category_type categoryType, p.regdate regdate, e.email email, e.nickname nickname, e.profile profile, e.score score,

(SELECT COUNT(l.no) FROM likes l WHERE p.no = l.content_no AND l.content_type='P') as countLikes, 
(SELECT count(c.no) FROM comments c WHERE p.no = c.post_no ) as countComments, 
(SELECT count(*) FROM views v WHERE p.no = v.post_no ) as countViews
FROM posts p 
left join explorers e
on p.explorer_no = e.no
WHERE p.no = #{no}

</select>

	<select id="selectList" resultType="Post" parameterType="map">		
SELECT no, explorerNo, title, content, categoryType, regdate, email, nickname, profile, score, r,countLikes, countComments,countViews 

FROM(

SELECT no, explorerNo, title, content, categoryType, regdate, email, nickname, profile, score, r,countLikes, countComments,countViews, SUM(countLikes+countComments+countViews) as counts
FROM(
SELECT p.no no, p.explorer_no explorerNo, p.title title, p.content content, p.category_type categoryType, p.regdate regdate, e.email email, e.nickname nickname, e.profile profile, e.score score,

(SELECT COUNT(l.no) FROM likes l WHERE p.no = l.content_no AND l.content_type='P') as countLikes, 
(SELECT count(c.no) FROM comments c WHERE p.no = c.post_no ) as countComments, 
(SELECT count(*) FROM views v WHERE p.no = v.post_no ) as countViews,

row_number() over() as r
FROM posts p 
left join explorers e
on p.explorer_no = e.no

WHERE 
<choose>
<when test="categoryType.equals('ALL')">
p.category_type IN('N','F','T','P')
</when>
<otherwise>
p.category_type = #{categoryType}
</otherwise>
</choose>
	<choose>
		<when test="text!=null and text.length()> 0">
		and
			<choose>
				<when test="searchOpt.equals('title')">
			p.title Like #{text}
		</when>
		<when test="searchOpt.equals('nickname')">
			e.nickname Like #{text}
		</when>
		<when test="searchOpt.equals('titleNcontent')">
		  (p.title Like #{text} OR p.content Like #{text})
		</when>
			</choose>
		
		</when>
		
	</choose>


) as TB1

group by TB1.no 

order by

<choose>
<when test="sortingType.equals('popularity')">
counts DESC
</when>
<otherwise>
TB1.no  DESC
</otherwise>
</choose>

) as TB2 

WHERE TB2.r BETWEEN #{start} AND #{end}
	</select>
	
	<select id="selectTotal" resultType="int" parameterType="map">
		SELECT count(*)
		FROM posts p 
left join explorers e
on p.explorer_no = e.no
		WHERE 
<choose>
<when test="categoryType.equals('ALL')">
p.category_type IN('N','F','T','P')
</when>
<otherwise>
p.category_type = #{categoryType}
</otherwise>
</choose>

<choose>
		<when test="text!=null and text.length()> 0">
		and
		<choose>	
		<when test="searchOpt.equals('titleNcontent')">
		  (p.title Like #{text} OR p.content Like #{text})
		</when>		
		<when test="searchOpt.equals('title')">
			p.title Like #{text}
		</when>
		<when test="searchOpt.equals('nickname')">
			e.nickname Like #{text}
		</when>
		
		</choose>
		
		</when>
		
	</choose>


</select>
	


</mapper>












